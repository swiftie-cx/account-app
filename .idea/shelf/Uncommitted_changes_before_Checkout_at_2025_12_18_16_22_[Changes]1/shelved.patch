Index: app/src/main/java/com/swiftiecx/timeledger/MainActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.swiftiecx.timeledger\r\n\r\nimport android.os.Bundle\r\nimport android.util.Log\r\nimport androidx.appcompat.app.AppCompatActivity\r\nimport androidx.activity.compose.setContent\r\nimport androidx.activity.enableEdgeToEdge\r\nimport androidx.compose.foundation.isSystemInDarkTheme\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.darkColorScheme\r\nimport androidx.compose.material3.lightColorScheme\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.lifecycle.ViewModel\r\nimport androidx.lifecycle.ViewModelProvider\r\nimport androidx.lifecycle.lifecycleScope\r\nimport androidx.work.ExistingPeriodicWorkPolicy\r\nimport androidx.work.PeriodicWorkRequestBuilder\r\nimport androidx.work.WorkManager\r\nimport com.swiftiecx.timeledger.data.AppDatabase\r\nimport com.swiftiecx.timeledger.data.ExpenseRepository\r\nimport com.swiftiecx.timeledger.ui.screen.MainScreen\r\nimport com.swiftiecx.timeledger.ui.viewmodel.ExpenseViewModel\r\nimport com.swiftiecx.timeledger.ui.viewmodel.ThemeViewModel\r\nimport com.swiftiecx.timeledger.worker.PeriodicWorker\r\nimport com.google.firebase.FirebaseApp\r\nimport kotlinx.coroutines.Dispatchers\r\nimport kotlinx.coroutines.launch\r\nimport java.util.concurrent.TimeUnit\r\n\r\nclass MainActivity : AppCompatActivity() {\r\n    private val TAG = \"MainActivity\"\r\n\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        Log.d(TAG, \"onCreate: 开始初始化\")\r\n\r\n        // --- 1. Firebase 安全初始化 ---\r\n        try {\r\n            if (FirebaseApp.getApps(this).isEmpty()) {\r\n                FirebaseApp.initializeApp(this)\r\n                Log.d(TAG, \"Firebase 手动初始化成功\")\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.e(TAG, \"Firebase 初始化失败: ${e.message}\")\r\n        }\r\n\r\n        // --- 2. 开启 Edge-to-Edge ---\r\n        enableEdgeToEdge()\r\n\r\n        try {\r\n            // --- 3. 初始化数据库和仓库 ---\r\n            Log.d(TAG, \"正在初始化数据库...\")\r\n            val database = AppDatabase.getDatabase(applicationContext)\r\n\r\n            // [关键修复] 补全参数：categoryDao，移除 context\r\n            val repository = ExpenseRepository(\r\n                expenseDao = database.expenseDao(),\r\n                budgetDao = database.budgetDao(),\r\n                accountDao = database.accountDao(),\r\n                periodicDao = database.periodicDao(),\r\n                categoryDao = database.categoryDao(), // [补上]\r\n                context = applicationContext\r\n            )\r\n            Log.d(TAG, \"Repository 初始化完成\")\r\n\r\n            // --- 4. 初始化 ViewModel ---\r\n            Log.d(TAG, \"正在初始化 ViewModel...\")\r\n\r\n            // 4.1 ExpenseViewModel (使用 Application)\r\n            val expenseViewModelFactory = object : ViewModelProvider.Factory {\r\n                override fun <T : ViewModel> create(modelClass: Class<T>): T {\r\n                    if (modelClass.isAssignableFrom(ExpenseViewModel::class.java)) {\r\n                        @Suppress(\"UNCHECKED_CAST\")\r\n                        // 传入 repository 和 application\r\n                        return ExpenseViewModel(repository, application) as T\r\n                    }\r\n                    throw IllegalArgumentException(\"Unknown ViewModel class\")\r\n                }\r\n            }\r\n            val expenseViewModel = ViewModelProvider(this, expenseViewModelFactory)[ExpenseViewModel::class.java]\r\n\r\n            // 4.2 ThemeViewModel\r\n            val themeViewModelFactory = ViewModelProvider.AndroidViewModelFactory.getInstance(application)\r\n            val themeViewModel = ViewModelProvider(this, themeViewModelFactory)[ThemeViewModel::class.java]\r\n            Log.d(TAG, \"ViewModel 初始化完成\")\r\n\r\n            // --- 5. 启动后台周期任务 (放到协程中) ---\r\n            lifecycleScope.launch(Dispatchers.IO) {\r\n                try {\r\n                    val workRequest = PeriodicWorkRequestBuilder<PeriodicWorker>(\r\n                        12, TimeUnit.HOURS\r\n                    ).build()\r\n\r\n                    WorkManager.getInstance(applicationContext).enqueueUniquePeriodicWork(\r\n                        \"PeriodicBookkeepingWork\",\r\n                        ExistingPeriodicWorkPolicy.KEEP,\r\n                        workRequest\r\n                    )\r\n                    Log.d(TAG, \"WorkManager 任务已入队\")\r\n                } catch (e: Exception) {\r\n                    Log.e(TAG, \"WorkManager 初始化失败: ${e.message}\")\r\n                }\r\n            }\r\n\r\n            // --- 6. 设置 UI 内容 ---\r\n            setContent {\r\n                val themeColor by themeViewModel.themeColor.collectAsState()\r\n                val isDarkTheme = isSystemInDarkTheme()\r\n\r\n                val colorScheme = if (isDarkTheme) {\r\n                    darkColorScheme(\r\n                        primary = themeColor,\r\n                        onPrimary = Color.White,\r\n                        primaryContainer = themeColor.copy(alpha = 0.3f),\r\n                        onPrimaryContainer = Color.White,\r\n                        background = Color(0xFF121212),\r\n                        surface = Color(0xFF1E1E1E),\r\n                        surfaceContainerLow = Color(0xFF1E1E1E)\r\n                    )\r\n                } else {\r\n                    lightColorScheme(\r\n                        primary = themeColor,\r\n                        onPrimary = Color.White,\r\n                        primaryContainer = themeColor.copy(alpha = 0.15f),\r\n                        onPrimaryContainer = themeColor,\r\n                        background = Color(0xFFF8F9FA),\r\n                        surface = Color.White,\r\n                        surfaceContainerLow = Color(0xFFF2F4F7),\r\n                        onSurface = Color(0xFF191C1E),\r\n                        onSurfaceVariant = Color(0xFF44474E),\r\n                        outline = Color(0xFF74777F),\r\n                        outlineVariant = Color(0xFFC4C7C5)\r\n                    )\r\n                }\r\n\r\n                MaterialTheme(\r\n                    colorScheme = colorScheme\r\n                ) {\r\n                    MainScreen(expenseViewModel, themeViewModel)\r\n                }\r\n            }\r\n            Log.d(TAG, \"setContent 完成，UI 应该显示\")\r\n\r\n        } catch (e: Exception) {\r\n            Log.e(TAG, \"FATAL: MainActivity 初始化过程发生严重错误\", e)\r\n        }\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/swiftiecx/timeledger/MainActivity.kt b/app/src/main/java/com/swiftiecx/timeledger/MainActivity.kt
--- a/app/src/main/java/com/swiftiecx/timeledger/MainActivity.kt	(revision 4a9d2e45288cfa9b4e3ebabaa5f27c340748d4f4)
+++ b/app/src/main/java/com/swiftiecx/timeledger/MainActivity.kt	(date 1766040283130)
@@ -107,6 +107,7 @@
             // --- 6. 设置 UI 内容 ---
             setContent {
                 val themeColor by themeViewModel.themeColor.collectAsState()
+                val currentLang by themeViewModel.language.collectAsState()
                 val isDarkTheme = isSystemInDarkTheme()
 
                 val colorScheme = if (isDarkTheme) {
